Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _reactNative=require('react-native');var _style=require('./style');var _style2=_interopRequireDefault(_style);var _utils=require('./utils');var _utils2=_interopRequireDefault(_utils);var _vars=require('./replacers/vars');var _vars2=_interopRequireDefault(_vars);var _mediaQueries=require('./replacers/media-queries');var _mediaQueries2=_interopRequireDefault(_mediaQueries);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var _class=function(){function _class(source){_classCallCheck(this,_class);this.source=source;this.result=Object.create(null);this.cache=new Map();this.nativeSheet={};this.globalVars=null;this.localVars=null;this.allVars=null;this.processedSource=null;}_createClass(_class,[{key:'calc',value:function calc(globalVars){this.globalVars=globalVars;this.clearResult();if(this.hasCache()){this.applyCache();}else{this.processMediaQueries();this.calcVars();this.calcStyles();this.calcNative();this.storeCache();}return this.getResult();}},{key:'processMediaQueries',value:function processMediaQueries(){this.processedSource=_mediaQueries2.default.process(this.source);}},{key:'calcVars',value:function calcVars(){var rawLocalVars=_vars2.default.extract(this.processedSource);if(rawLocalVars){this.localVars=new _style2.default(rawLocalVars,[rawLocalVars,this.globalVars]).calc().calculatedVars;_extends(this.result,this.localVars);}else{this.localVars=null;}this.allVars=[this.localVars,this.globalVars].filter(Boolean);}},{key:'calcStyles',value:function calcStyles(){var _this=this;var extractedStyles=_utils2.default.excludeKeys(this.processedSource,this.localVars);Object.keys(extractedStyles).forEach(function(key){var styles=extractedStyles[key];if(typeof styles==='function'){styles=styles();}if(styles&&typeof styles==='object'){_this.calcStyle(key,styles);}else{_this.result[key]=styles;}});}},{key:'calcStyle',value:function calcStyle(key,styleProps){var style=new _style2.default(styleProps,this.allVars);var _style$calc=style.calc(),calculatedProps=_style$calc.calculatedProps,calculatedVars=_style$calc.calculatedVars;var merged=_extends({},calculatedVars,calculatedProps);if(key.charAt(0)==='_'){this.result[key]=merged;}else{this.result['_'+key]=merged;this.nativeSheet[key]=calculatedProps;}}},{key:'calcNative',value:function calcNative(){if(Object.keys(this.nativeSheet).length){var rnStyleSheet=_reactNative.StyleSheet.create(this.nativeSheet);_extends(this.result,rnStyleSheet);}}},{key:'getResult',value:function getResult(){return this.result;}},{key:'clearResult',value:function clearResult(){var _this2=this;Object.keys(this.result).forEach(function(key){return delete _this2.result[key];});}},{key:'hasCache',value:function hasCache(){var key=this.getCacheKey();return key&&this.cache.has(key);}},{key:'applyCache',value:function applyCache(){var cachedResult=this.cache.get(this.getCacheKey());_extends(this.result,cachedResult);}},{key:'storeCache',value:function storeCache(){var key=this.getCacheKey();if(key){this.cache.set(key,_extends({},this.result));}}},{key:'clearCache',value:function clearCache(){this.cache.clear();}},{key:'getCacheKey',value:function getCacheKey(){return this.globalVars&&this.globalVars.$theme;}}]);return _class;}();exports.default=_class;
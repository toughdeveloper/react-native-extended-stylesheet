Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _reactNative=require('react-native');var _sheet=require('./sheet');var _sheet2=_interopRequireDefault(_sheet);var _style=require('./style');var _style2=_interopRequireDefault(_style);var _value=require('./value');var _value2=_interopRequireDefault(_value);var _vars=require('./replacers/vars');var _vars2=_interopRequireDefault(_vars);var _mediaQueries=require('./replacers/media-queries');var _mediaQueries2=_interopRequireDefault(_mediaQueries);var _child=require('./child');var _child2=_interopRequireDefault(_child);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var BUILD_EVENT='build';var EStyleSheet=function(){function EStyleSheet(){_classCallCheck(this,EStyleSheet);this.child=_child2.default;this.builded=false;this.sheets=[];this.globalVars=null;this.listeners={};this._proxyToOriginal();}_createClass(EStyleSheet,[{key:'create',value:function create(obj){var sheet=new _sheet2.default(obj);this.sheets.push(sheet);if(this.builded){sheet.calc(this.globalVars);}return sheet.getResult();}},{key:'build',value:function build(rawGlobalVars){this.builded=true;this._calcGlobalVars(rawGlobalVars);this._calcSheets();this._callListeners(BUILD_EVENT);}},{key:'value',value:function value(expr,prop){var varsArr=this.globalVars?[this.globalVars]:[];return new _value2.default(expr,prop,varsArr).calc();}},{key:'subscribe',value:function subscribe(event,listener){if(event!==BUILD_EVENT){throw new Error('Only \''+BUILD_EVENT+'\' event is currently supported.');}if(typeof listener!=='function'){throw new Error('Listener should be a function.');}if(this.builded){listener();}else{this.listeners[BUILD_EVENT]=this.listeners[BUILD_EVENT]||[];this.listeners[BUILD_EVENT].push(listener);}}},{key:'clearCache',value:function clearCache(){this.sheets.forEach(function(sheet){return sheet.clearCache();});}},{key:'_calcGlobalVars',value:function _calcGlobalVars(rawGlobalVars){if(rawGlobalVars){this._checkGlobalVars(rawGlobalVars);rawGlobalVars.$theme=rawGlobalVars.$theme||'default';this.globalVars=new _style2.default(rawGlobalVars,[rawGlobalVars]).calc().calculatedVars;}}},{key:'_calcSheets',value:function _calcSheets(){var _this=this;this.sheets.forEach(function(sheet){return sheet.calc(_this.globalVars);});}},{key:'_callListeners',value:function _callListeners(event){if(Array.isArray(this.listeners[event])){this.listeners[event].forEach(function(listener){return listener();});}}},{key:'_proxyToOriginal',value:function _proxyToOriginal(){var _this2=this;var props=['setStyleAttributePreprocessor','hairlineWidth','absoluteFill','absoluteFillObject','flatten'];props.forEach(function(prop){Object.defineProperty(_this2,prop,{get:function get(){return _reactNative.StyleSheet[prop];},enumerable:true});});}},{key:'_checkGlobalVars',value:function _checkGlobalVars(rawGlobalVars){Object.keys(rawGlobalVars).forEach(function(key){if(!_vars2.default.isVar(key)&&!_mediaQueries2.default.isMediaQuery(key)){throw new Error('EStyleSheet.build() params should contain global variables (start with $) '+('or media queries (start with @media). Got \''+key+'\'.'));}});}}]);return EStyleSheet;}();exports.default=EStyleSheet;